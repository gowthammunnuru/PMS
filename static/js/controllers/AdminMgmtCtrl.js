// Generated by CoffeeScript 1.10.0
(function() {
  angular.module("perform").controller("AdminMgmtCtrl", [
    "$scope", "$rootScope", "$stateParams", "$sanitize", "allAdmins", "allUsers", "Auth", "Cache", function($scope, $rootScope, $sanitize, $stateParams, allAdmins, allUsers, Auth, Cache) {

      /*
        DDU Employees : o(organization)= "DreamWorks Animation International Services, Inc"
                        Active: true
                        physicalDeliveryOfficeName: !(CHINA-OFFSITE)
        DWA Employees :  o = "DreamWorks Animation L.L.C. "
                        Active: true
       */
      var appendCorrectRolesAndPermissions, roles;
      roles = [];
      roles = [
        {
          'name': 'Master_Tigress',
          'permissions': ['SETUP_REVIEWS', 'EDIT_REVIEWS'],
          'assigned': true
        }, {
          'name': 'Master_Shifu',
          'permissions': ['SETUP_REVIEWS', 'EDIT_REVIEWS', 'EDIT_HR'],
          'assigned': false
        }, {
          'name': 'Master_Oogway',
          'permissions': ['SETUP_REVIEWS', 'EDIT_REVIEWS', 'SETUP_ROLES', 'EDIT_HR'],
          'assigned': false
        }
      ];
      $scope.roles = roles;
      $scope.allAdmins = allAdmins;
      $scope.allUsers = allUsers;
      $scope.viewAdmins = true;
      $scope.editAdmins = false;
      $scope.toggleViews = function(value) {
        if (value === 'view') {
          $scope.viewAdmins = true;
          return $scope.editAdmins = false;
        } else {
          $scope.viewAdmins = false;
          return $scope.editAdmins = true;
        }
      };
      $scope.removeRole = function(record, role) {
        var a;
        a = _.findWhere(record.rolesToAssign, {
          name: role
        });
        a['assigned'] = !a.assigned;
        console.log($sanitize(record.rolesToAssign));
        if (!$scope.$$phase) {
          return $scope.$apply();
        }
      };
      $scope.removeAdmin = function(record) {
        return Cache.removeAdmin(record).then(function(response) {
          return allAdmins.splice(allAdmins.indexOf(record), 1);
        });
      };
      appendCorrectRolesAndPermissions = function(record) {
        record.permissions = _.uniq(_.flatten(_.pluck(record.rolesToAssign, 'permissions')));
        record.roles = _.pluck(record.rolesToAssign, 'name');
        return record;
      };
      $scope.addAdmin = function(record) {
        record.rolesToAssign = _.filter(record.rolesToAssign, function(a) {
          return a.assigned;
        });
        return Cache.addAdmin(appendCorrectRolesAndPermissions(record)).then(function(response) {
          $scope.showSuccess = true;
          if (_.isEmpty(_.findWhere(allAdmins, {
            'uid': record.uid
          }))) {
            return allAdmins.push(record);
          } else {
            return allAdmins[allAdmins.indexOf(_.findWhere(allAdmins, {
              'uid': record.uid
            }))] = record;
          }
        });
      };
      $scope.closeAlert = function(index) {
        return $scope.showSuccess = false;
      };
      console.log($scope.allUsers);
      return $scope.usersByLocation = _.filter($scope.allUsers, function(user) {
        user.rolesToAssign = [
          {
            'name': 'Master_Tigress',
            'permissions': ['SETUP_REVIEWS', 'EDIT_REVIEWS'],
            'assigned': true
          }, {
            'name': 'Master_Shifu',
            'permissions': ['SETUP_REVIEWS', 'EDIT_REVIEWS', 'EDIT_HR'],
            'assigned': false
          }, {
            'name': 'Master_Oogway',
            'permissions': ['SETUP_REVIEWS', 'EDIT_REVIEWS', 'SETUP_ROLES', 'EDIT_HR'],
            'assigned': false
          }
        ];
        user.uname = user.givenName + " " + user.surname;
        return user.active && user.organization === Auth.getUser().organization && user.location.id.indexOf('china-offsite') === -1;
      });
    }
  ]);

}).call(this);
