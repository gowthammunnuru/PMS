// Generated by CoffeeScript 1.10.0
"use strict";
var app, ref;

app = angular.module("perform", ["ui.router", "ui.sortable", "ui.utils", "ui.bootstrap", "ngRoute", "ngSanitize", "ngCookies"]);

app.run(function($window, $rootScope, $state, $stateParams, $sanitize, BG, Cache, Auth, Utils, Reviews) {
  $rootScope.$window = $window;
  $rootScope.$state = $state;
  $rootScope.$stateParams = $stateParams;
  $rootScope.deferPresent = false;
  $rootScope.auth = function() {
    return Auth.getSession();
  };
  $rootScope.Auth = Auth;
  $rootScope.BG = BG;
  $rootScope.$watch('deferPresent', function(newValue, oldValue) {
    if (newValue === true) {
      return Utils.showLoading();
    } else {
      return Utils.hideLoading();
    }
  });
  $rootScope.cache = Cache;
  $rootScope.$on('connection-open', function() {
    return Utils.hideConnectionLost();
  });
  $rootScope.$on('connection-lost', function() {
    return Utils.showConnectionLost();
  });
  $rootScope.goToHome = function() {
    if ($rootScope.Auth.getStatus() && $state.current.name !== 'landing.home') {
      return BG.go('landing.home', {}, {});
    }
  };
  $rootScope.$on("$stateChangeStart", function(event, toState, toParams, fromState, fromParams) {
    var ref;
    console.log($sanitize("[ROUTE-CHANGE]: " + $state.current.name + " -> " + toState.name, $state.goingTo));
    if (!fromState.name === 'user_review_year.start') {
      if ($rootScope.preventNavigation) {
        console.log('Unsaved changes. Preventing this move.');
        event.preventDefault();
        return;
      }
    }
    Utils.showLoading();
    if (fromState.name === 'user_review_year.section' || fromState.name === 'multi_user_review_year.section' || fromState === 'user_self_review_year.section') {
      Reviews.stopAutoUpdate();
    }
    if (toState.name !== 'landing.login' && !Auth.getStatus()) {
      console.log('reject!');
      Reviews.stopAutoUpdate();
      if ($state.current.name === "landing.login") {
        $state.transitionTo('landing.login', {
          auth_error: 401
        }, {
          notify: false
        });
      } else {
        $state.go('landing.login');
        Auth.rejectState = [toState, toParams];
      }
      Utils.hideLoading();
      event.preventDefault();
    }
    if (toState.name === "auth_error") {
      toState.data.rejectState = $state.goingTo[1];
      toState.data.rejectParams = $state.goingTo[2];
      return (ref = $state.goingTo[0]) != null ? ref.preventDefault() : void 0;
    } else if (!fromState.name) {
      return console.log('XXXXXXXXXXXXXXX FIX ME XXXXXXXXXXXXXXX');
    } else {
      return $state.goingTo = [event, toState, toParams];
    }
  });
  $rootScope.$on("$stateChangeSuccess", function(event, toState, toParams, fromState, fromParams) {
    console.log("[ROUTE-SUCCESS]: " + fromState.name + " -> " + toState.name);
    $state.goingTo = [];
    Utils.hideLoading();
  });
  $rootScope.$on("$stateChangeError", function(event, toState, toParams, fromState, fromParams) {
    console.log(event);
  });
  Cache.getAppMetadata().then(function(response) {
    return $rootScope.metadata = response;
  });
});

if ((ref = window.location.host) !== "perform" && ref !== "perform.ddu-india.com") {
  angular.element('#favicon').attr('href', 'static/media/images/favicon_dev.png');
}
